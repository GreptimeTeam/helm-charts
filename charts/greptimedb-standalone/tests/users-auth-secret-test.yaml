suite: users-auth-secret tests
templates:
  - users-auth-secret.yaml
tests:
  - it: should not create secret when auth is disabled
    set:
      auth:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create secret with basic auth (no permission)
    set:
      auth:
        enabled: true
        fileName: passwd
        users:
          - username: admin
            password: admin_secret
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.passwd
          value: |
            admin=admin_secret

  - it: should create secret with permission (readwrite)
    set:
      auth:
        enabled: true
        fileName: passwd
        users:
          - username: admin
            password: admin_secret
            permission: readwrite
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.passwd
          value: |
            admin:readwrite=admin_secret

  - it: should create secret with permission (readonly)
    set:
      auth:
        enabled: true
        fileName: passwd
        users:
          - username: grafana
            password: grafana_pwd
            permission: readonly
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.passwd
          value: |
            grafana:readonly=grafana_pwd

  - it: should create secret with permission (writeonly)
    set:
      auth:
        enabled: true
        fileName: passwd
        users:
          - username: telegraf
            password: telegraf_pwd
            permission: writeonly
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.passwd
          value: |
            telegraf:writeonly=telegraf_pwd

  - it: should create secret with multiple users with different permissions
    set:
      auth:
        enabled: true
        fileName: passwd
        users:
          - username: admin
            password: admin_secret
            permission: readwrite
          - username: grafana
            password: grafana_pwd
            permission: readonly
          - username: telegraf
            password: telegraf_pwd
            permission: writeonly
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.passwd
          value: |
            admin:readwrite=admin_secret
            grafana:readonly=grafana_pwd
            telegraf:writeonly=telegraf_pwd

  - it: should create secret with mixed users (some with permission, some without)
    set:
      auth:
        enabled: true
        fileName: passwd
        users:
          - username: admin
            password: admin_secret
            permission: readwrite
          - username: grafana
            password: grafana_pwd
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.passwd
          value: |
            admin:readwrite=admin_secret
            grafana=grafana_pwd
