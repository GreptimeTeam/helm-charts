suite: secret tests
templates:
  - secret.yaml
tests:
  - it: should not create secret when objectStorage is not configured
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create secret when credentials are not configured
    set:
      objectStorage:
        s3:
          bucket: my-bucket
          region: us-west-2
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create secret when existingSecretName is provided
    set:
      objectStorage:
        s3:
          bucket: my-bucket
        credentials:
          existingSecretName: my-existing-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should create secret with S3 credentials
    release:
      name: mystandalone
    set:
      objectStorage:
        s3:
          bucket: my-bucket
        credentials:
          accessKeyId: my-access-key
          secretAccessKey: my-secret-key
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: mystandalone-greptimedb-standalone-secret
      - equal:
          path: stringData.GREPTIMEDB_STANDALONE__STORAGE__ACCESS_KEY_ID
          value: my-access-key
      - equal:
          path: stringData.GREPTIMEDB_STANDALONE__STORAGE__SECRET_ACCESS_KEY
          value: my-secret-key

  - it: should create secret with OSS credentials
    release:
      name: mystandalone
    set:
      objectStorage:
        oss:
          bucket: my-bucket
        credentials:
          accessKeyId: my-access-key
          accessKeySecret: my-access-key-secret
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.GREPTIMEDB_STANDALONE__STORAGE__ACCESS_KEY_ID
          value: my-access-key
      - equal:
          path: stringData.GREPTIMEDB_STANDALONE__STORAGE__ACCESS_KEY_SECRET
          value: my-access-key-secret

  - it: should create secret with Azure credentials
    release:
      name: mystandalone
    set:
      objectStorage:
        azblob:
          container: my-container
        credentials:
          accountName: my-account
          accountKey: my-account-key
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.GREPTIMEDB_STANDALONE__STORAGE__ACCOUNT_NAME
          value: my-account
      - equal:
          path: stringData.GREPTIMEDB_STANDALONE__STORAGE__ACCOUNT_KEY
          value: my-account-key

  - it: should create secret with GCS credentials (base64 encoded)
    release:
      name: mystandalone
    set:
      objectStorage:
        gcs:
          bucket: my-bucket
        credentials:
          serviceAccountKey: eyJrZXkiOiJ2YWx1ZSJ9
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: data.GREPTIMEDB_STANDALONE__STORAGE__CREDENTIAL
          value: ZXlKclpYa2lPaUoyWVd4MVpTSjk=
